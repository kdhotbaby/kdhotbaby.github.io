<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="hotbaby's blog"><title>nginx autoindex 乱码 | hotbaby</title><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/5.0.0/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.2/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.2/grids-responsive-min.css"><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/3.1.1/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><link rel="alternate" type="application/atom+xml" href="/atom.xml"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">nginx autoindex 乱码</h1><a id="logo" href="/.">hotbaby</a><p class="description">hotbaby's blog</p></div><div id="nav-menu"><a href="/." class="current"><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/history/"><i class="fa fa-history"> 历史</i></a><a href="/guestbook/"><i class="fa fa-comments"> 留言</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a></div></div><div id="layout" class="pure-g"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">nginx autoindex 乱码</h1><div class="post-meta">May 9, 2017<script src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js" async></script><span id="busuanzi_container_page_pv"> | <span id="busuanzi_value_page_pv"></span><span> Hits</span></span></div><a data-disqus-identifier="2017/05/09/nginx-autoindex-乱码/" href="/2017/05/09/nginx-autoindex-乱码/#disqus_thread" class="disqus-comment-count"></a><div class="post-content"><p>使用nginx_autoindex_moudle检索本地文件时，如果文件名字包含中文，则会出现乱码.</p>
<p>nginx配置文件如下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">location /static/ &#123;</div><div class="line">alias $static/;        </div><div class="line">autoindex on;</div><div class="line">autoindex_exact_size on;</div><div class="line">autoindex_localtime on;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>检查发现nginx auto_index 生成的html文件header未包含<strong>charset</strong></p>
<p>nginx 源码剖析</p>
<p><code>src/http/modules/ngx_http_autoindex_module.c</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">switch</span> (format) &#123;</div><div class="line"></div><div class="line"><span class="keyword">case</span> NGX_HTTP_AUTOINDEX_JSON:</div><div class="line">    ngx_str_set(&amp;r-&gt;headers_out.content_type, <span class="string">"application/json"</span>);</div><div class="line">    <span class="keyword">break</span>;</div><div class="line"></div><div class="line"><span class="keyword">case</span> NGX_HTTP_AUTOINDEX_JSONP:</div><div class="line">    ngx_str_set(&amp;r-&gt;headers_out.content_type, <span class="string">"application/javascript"</span>);</div><div class="line">    <span class="keyword">break</span>;</div><div class="line"></div><div class="line"><span class="keyword">case</span> NGX_HTTP_AUTOINDEX_XML:</div><div class="line">    ngx_str_set(&amp;r-&gt;headers_out.content_type, <span class="string">"text/xml"</span>);</div><div class="line">    ngx_str_set(&amp;r-&gt;headers_out.charset, <span class="string">"utf-8"</span>);</div><div class="line">    <span class="keyword">break</span>;</div><div class="line"></div><div class="line"><span class="keyword">default</span>: <span class="comment">/* NGX_HTTP_AUTOINDEX_HTML */</span></div><div class="line">    ngx_str_set(&amp;r-&gt;headers_out.content_type, <span class="string">"text/html"</span>);</div><div class="line">    <span class="keyword">break</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>确认<strong>autoindex_format</strong>为html时，确实未增加charset的http头部信息。</p>
<p>修改源代码</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">default</span>: <span class="comment">/* NGX_HTTP_AUTOINDEX_HTML */</span></div><div class="line">    ngx_str_set(&amp;r-&gt;headers_out.content_type, <span class="string">"text/html"</span>);</div><div class="line">    ngx_str_set(&amp;r-&gt;headers_out.charset, <span class="string">"utf-8"</span>);</div><div class="line">    <span class="keyword">break</span>;</div></pre></td></tr></table></figure>
<p>重新编译nginx</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">$ ./configure --prefix=/opt/nginx --with-http_ssl_module</div><div class="line">$ make; make install</div></pre></td></tr></table></figure>
<p>重启nginx</p>
<p>强制刷新页面， OK, 问题解决</p>
<p> <em>An official read-only mirror of <a href="http://hg.nginx.org/nginx/" target="_blank" rel="external">http://hg.nginx.org/nginx/</a> which is updated hourly. Pull requests on GitHub cannot be accepted and will be automatically closed. The proper way to submit changes to nginx is via the nginx development mailing list, see <a href="http://nginx.org/en/docs/contributing_changes.html" target="_blank" rel="external">http://nginx.org/en/docs/contributing_changes.html</a> <a href="http://nginx.org/" target="_blank" rel="external">http://nginx.org/</a></em></p>
<p> nginx 不支持github pull request. Fuck</p>
<h2 id="References"><a href="#References" class="headerlink" title="References"></a>References</h2><ul>
<li><a href="https://github.com/nginx/nginx" target="_blank" rel="external">nginx github repo</a></li>
<li><a href="https://nginx.org/en/docs/http/ngx_http_autoindex_module.html" target="_blank" rel="external">nginx autoindex module document</a></li>
</ul>
</div><script type="text/javascript" src="/js/share.js?v=0.0.0" async></script><a data-url="http://blog.hotbaby.org/2017/05/09/nginx-autoindex-乱码/" data-id="cj5k9ww3o003rpbfsvok6kjae" class="article-share-link">分享到</a><div class="tags"><a href="/tags/nginx/">nginx</a></div><div class="post-nav"><a href="/2017/05/14/Flask-signal/" class="pre">Flask Signal</a><a href="/2017/05/08/shadowsocks/" class="next">Shadowsocks</a></div><div id="disqus_thread"><script>var disqus_shortname = 'hotbaby-1';
var disqus_identifier = '2017/05/09/nginx-autoindex-乱码/';
var disqus_title = 'nginx autoindex 乱码';
var disqus_url = 'http://blog.hotbaby.org/2017/05/09/nginx-autoindex-乱码/';
(function() {
  var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
  dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();</script><script id="dsq-count-scr" src="//hotbaby-1.disqus.com/count.js" async></script></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form action="//www.baidu.com/baidu" method="get" accept-charset="utf-8" target="_blank" class="search-form"><input type="search" name="word" maxlength="20" placeholder="Search"/><input type="hidden" name="si" value="http://blog.hotbaby.org"/><input name="tn" type="hidden" value="bds"/><input name="cl" type="hidden" value="3"/><input name="ct" type="hidden" value="2097152"/><input name="s" type="hidden" value="on"/></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/django/">django</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/git/">git</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/旅行/">旅行</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/tags/Cobra/" style="font-size: 15px;">Cobra</a> <a href="/tags/Python/" style="font-size: 15px;">Python</a> <a href="/tags/django/" style="font-size: 15px;">django</a> <a href="/tags/Lisp/" style="font-size: 15px;">Lisp</a> <a href="/tags/Paul-Graham/" style="font-size: 15px;">Paul Graham</a> <a href="/tags/电影/" style="font-size: 15px;">电影</a> <a href="/tags/跑步/" style="font-size: 15px;">跑步</a> <a href="/tags/PEP/" style="font-size: 15px;">PEP</a> <a href="/tags/PyPI/" style="font-size: 15px;">PyPI</a> <a href="/tags/decorator/" style="font-size: 15px;">decorator</a> <a href="/tags/closure/" style="font-size: 15px;">closure</a> <a href="/tags/Flask/" style="font-size: 15px;">Flask</a> <a href="/tags/RSS/" style="font-size: 15px;">RSS</a> <a href="/tags/selenium/" style="font-size: 15px;">selenium</a> <a href="/tags/cache/" style="font-size: 15px;">cache</a> <a href="/tags/git/" style="font-size: 15px;">git</a> <a href="/tags/hexo/" style="font-size: 15px;">hexo</a> <a href="/tags/HTTP/" style="font-size: 15px;">HTTP</a> <a href="/tags/json/" style="font-size: 15px;">json</a> <a href="/tags/nginx/" style="font-size: 15px;">nginx</a> <a href="/tags/shadowsocks/" style="font-size: 15px;">shadowsocks</a> <a href="/tags/OAuth/" style="font-size: 15px;">OAuth</a> <a href="/tags/互联网/" style="font-size: 15px;">互联网</a> <a href="/tags/八达岭长城/" style="font-size: 15px;">八达岭长城</a> <a href="/tags/腾讯/" style="font-size: 15px;">腾讯</a> <a href="/tags/读书/" style="font-size: 15px;">读书</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最新文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2017/07/23/http-cache/">HTTP Cache</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/07/19/untitled-1499683380864/">OAuth</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/07/18/untitled-1500307428319/">Python Metaclass</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/07/10/Python-descriptor/">Python  Descriptor</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/07/09/Selenium/">Selenium</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/07/09/Python-context/">Python Context</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/06/09/Python-debug/">Python Debug</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/06/09/debian-timezone/">Debian Timezone</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/06/09/Python-customization/">Python Customization</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/06/08/Python-pip-mirror/">Python PyPI Mirror</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 友情链接</i></div><ul></ul><a href="http://paulgraham.com/" title="Paul Graham" target="_blank">Paul Graham</a><ul></ul><a href="http://babywolfh.win" title="babywolfh's blog" target="_blank">babywolfh's blog</a><ul></ul><a href="https://www.haomwei.com/" title="9441's blog" target="_blank">9441's blog</a><ul></ul><a href="https://www.biaodianfu.com/" title="标点符" target="_blank">标点符</a><ul></ul><a href="https://docs.python.org/2/" title="Python 2.7.12 Documentation" target="_blank">Python 2.7.12 Documentation</a><ul></ul><a href="http://aosabook.org/en/index.html" title="The Architecture of Open Source Applications" target="_blank">The Architecture of Open Source Applications</a><ul></ul><a href="http://www.pycon.org/" title="Python Community" target="_blank">Python Community</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">© 2017 <a href="/." rel="nofollow">hotbaby</a></div></div></div><a id="rocket" href="#top" class="show"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.pack.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="/css/jquery.fancybox.css?v=0.0.0"><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "//hm.baidu.com/hm.js?bf8f991bdc9a9dc0e9009de94acefaf6";
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(hm, s);
  })();
</script><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>