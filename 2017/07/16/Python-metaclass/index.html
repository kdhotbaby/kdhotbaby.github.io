<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="hotbaby's blog"><title>Python metaclass | hotbaby</title><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/5.0.0/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.2/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.2/grids-responsive-min.css"><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/3.1.1/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><link rel="alternate" type="application/atom+xml" href="/atom.xml"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">Python metaclass</h1><a id="logo" href="/.">hotbaby</a><p class="description">hotbaby's blog</p></div><div id="nav-menu"><a href="/." class="current"><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/history/"><i class="fa fa-history"> 历史</i></a><a href="/guestbook/"><i class="fa fa-comments"> 留言</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a></div></div><div id="layout" class="pure-g"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">Python metaclass</h1><div class="post-meta">Jul 16, 2017<script src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js" async></script><span id="busuanzi_container_page_pv"> | <span id="busuanzi_value_page_pv"></span><span> Hits</span></span></div><a data-disqus-identifier="2017/07/16/Python-metaclass/" href="/2017/07/16/Python-metaclass/#disqus_thread" class="disqus-comment-count"></a><div class="post-content"><p><strong>[Metaclasses] are deeper magic than 99% of users should ever worry about. If you wonder whether you need them, you don’t (the people who actually need them know with certainty that they need them, and don’t need an explanation about why).</strong></p>
<p>In other words, metaclasses are ultimately just another way to define automatically run code. With the tools listed in the prior section, Python provides ways for us to interject logic in a variety of contexts—at operator evaluation, attribute access, function calls, class instance creation, and now class object creation. It’s a language with hooks galore —a feature open to abuse like any other, but one that also offers the flexibility that some programmers desire, and that some programs may require.</p>
<p>instances are created from classes, and classes are created from type</p>
<p>• Types are defined by classes that derive from type.<br>• User-defined classes are instances of type classes.<br>• User-defined classes are types that generate instances of their own.</p>
<h2 id="Metaclasses-Are-Subclasses-of-Type"><a href="#Metaclasses-Are-Subclasses-of-Type" class="headerlink" title="Metaclasses Are Subclasses of Type"></a>Metaclasses Are Subclasses of Type</h2><p>• type is a class that generates user-defined classes.<br>• Metaclasses are subclasses of the type class.<br>• Class objects are instances of the type class, or a subclass thereof.<br>• Instance objects are generated from a class.</p>
<h2 id="Class-Statement-Protocol"><a href="#Class-Statement-Protocol" class="headerlink" title="Class Statement Protocol"></a>Class Statement Protocol</h2><p>We’ve already learned that when Python reaches a class statement, it runs its nested block of code to create its attributes—all the names assigned at the top level of the nested code block generate attributes in the resulting class object. These names are usually method functions created by nested defs, but they can also be arbitrary attributes assigned to create class data shared by all instances.<br>Technically speaking, Python follows a standard protocol to make this happen: at the end of a class statement, and after running all its nested code in a namespace dictionary corresponding to the class’s local scope, Python calls the type object to create the class object like this:<br><code>class = type(classname, superclasses, attributedict)</code></p>
<p>The type object in turn defines a <strong>call</strong> operator overloading method that runs two other methods when the type object is called:</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">type.__new__(typeclass, classname, superclasses, attributedict)</div><div class="line">type.__init__(class, classname, superclasses, attributedict)</div></pre></td></tr></table></figure>
<h2 id="Inheritance-and-Instance"><a href="#Inheritance-and-Instance" class="headerlink" title="Inheritance and Instance"></a>Inheritance and Instance</h2><ul>
<li>Metaclass inherit from the type class(usually)</li>
<li>Metaclass declarations are inherited by subclasses</li>
<li>Metaclass attributes are not inherited by class instances</li>
<li>Metaclass attributes are acquired by classes</li>
</ul>
<p><em>Metaclass inherit from the type class(usually)</em></p>
<p>Metaclass typically redefined the type class’s <code>__new__</code> and <code>__init__</code> to customize class creation and initialization.</p>
<p><em>Metaclass declarations are inherited by subclass</em></p>
<p>The <code>metaclass=M</code> declaration in a user-defined class is inherited by the class’s normal subclass, so the metaclass will run for the construction of each class that inherits this specification in a superclass inheritance chain.</p>
<p><em>Metaclass attributes are not inherited by class instances</em></p>
<p>classes are instances of metaclass, the behavior defined in a metaclass applies to the class, but not the class’s later instance.</p>
<p><em>Metaclass attributes are acquired by classes</em></p>
<h2 id="Inheritance-The-Full-Story"><a href="#Inheritance-The-Full-Story" class="headerlink" title="Inheritance: The Full Story"></a>Inheritance: The Full Story</h2><p>instance inheritances works in similar ways, whether the “instance” is created from a normal class, or is class created from a metalcass subclass of type.</p>
<p><strong>Python’s inheritance algorithm: The simple version</strong></p>
<p>Technically, inheritane deploys two distinct but similar lookup routines, and is based on MROs. Because <code>__bases__</code> are used to construct the <code>__mro__</code> ordering at class creation time, and because class’s <code>__mro__</code> inlcudes itself, the prior section’s generalization is the same as the following</p>
<ol>
<li><p>From an instance I, search the instance, the its class, and then all its superclasses<br>a. The <code>__dict__</code> of. the instance I.<br>b. The <code>__dict__</code> of all classes on the <code>__mro__</code> found at I’s <code>__class__</code>, from left to right</p>
</li>
<li><p>From a class C, search the class, then all its superclasses, and then its metaclass tree using:<br>a. The <code>__dict__</code> of all the classes on the <code>__mro__</code> found at C itslef, from left to right<br>b. The <code>__dict__</code> of all metaclasses on the <code>__mro__</code> found at C’s <code>__class__</code>, from left to right</p>
</li>
<li><p>In both rule 1 and 2, give precedence to data descriptor located in step b sources</p>
</li>
<li><p>In both rule 1 and 2, skip a and begin the search at step b for built-in operations</p>
</li>
</ol>
<p><strong>The descriptors special case</strong></p>
<p>In short, some descriptors known as data descriptors –those that defined <code>__set__</code> methods to intercept assignments– are given precedence, such that their names override other their inheritance sources.</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&gt;&gt;&gt; </span><span class="class"><span class="keyword">class</span> <span class="title">D</span><span class="params">(object)</span>:</span></div><div class="line"><span class="meta">... </span>    <span class="function"><span class="keyword">def</span> <span class="title">__get__</span><span class="params">(self, ins, _type)</span>:</span></div><div class="line"><span class="meta">... </span>            print(<span class="string">'call D.__get__'</span>)</div><div class="line"><span class="meta">... </span>    <span class="function"><span class="keyword">def</span> <span class="title">__set__</span><span class="params">(self, ins, value)</span>:</span></div><div class="line"><span class="meta">... </span>            print(<span class="string">'call D.__set__'</span>)</div><div class="line"><span class="meta">... </span></div><div class="line"><span class="meta">&gt;&gt;&gt; </span></div><div class="line"><span class="meta">&gt;&gt;&gt; </span><span class="class"><span class="keyword">class</span> <span class="title">Dummy</span><span class="params">(object)</span>:</span></div><div class="line"><span class="meta">... </span>    d = D()</div><div class="line"><span class="meta">... </span></div><div class="line"><span class="meta">&gt;&gt;&gt; </span>ins = Dummy()</div><div class="line"><span class="meta">&gt;&gt;&gt; </span>ins.d</div><div class="line">call D.__get__</div><div class="line"><span class="meta">&gt;&gt;&gt; </span>ins.d = <span class="string">'spam'</span></div><div class="line">call D.__set__</div></pre></td></tr></table></figure>
<p>If this descriptor did not define a <code>__set__</code>, the name in the instance’s dictionary would hide the name in its class instead, per normal inheritance:</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&gt;&gt;&gt; </span><span class="class"><span class="keyword">class</span> <span class="title">D</span><span class="params">(object)</span>:</span></div><div class="line"><span class="meta">... </span>    <span class="function"><span class="keyword">def</span> <span class="title">__get__</span><span class="params">(self, ins, value)</span>:</span></div><div class="line"><span class="meta">... </span>            print(<span class="string">'call D.__get__'</span>)</div><div class="line"><span class="meta">... </span></div><div class="line"><span class="meta">&gt;&gt;&gt; </span><span class="class"><span class="keyword">class</span> <span class="title">Dummy</span><span class="params">(object)</span>:</span></div><div class="line"><span class="meta">... </span>    d = D()</div><div class="line"><span class="meta">... </span></div><div class="line"><span class="meta">&gt;&gt;&gt; </span>ins = Dummy()</div><div class="line"><span class="meta">&gt;&gt;&gt; </span>ins.d</div><div class="line">call D.__get__</div><div class="line"><span class="meta">&gt;&gt;&gt; </span>ins.d = <span class="string">'spam'</span></div><div class="line"><span class="meta">&gt;&gt;&gt; </span>ins.d</div><div class="line"><span class="string">'spam</span></div></pre></td></tr></table></figure>
<p><strong>Python’s inheritance algorithm: The somewhat-more-complete version</strong></p>
<p>Python’s full new-style inheritance algorithm can be stated as follows - a complex procedure, which assumes knowledge of descriptors, metaclass, and MROs, but is the final arbiter of attribute names nonetheless.</p>
<p><em>To look up an explicit attribute name:</em></p>
<ol>
<li><p>From an instance I, search the instance, its class, and its superclasses, as follows:</p>
<p> a.  Search the <code>__dict__</code> of all classes on the <code>__mro__</code> at I’s <code>__class__</code><br> b.  If a data descriptor was foudn in step a, call it and exit<br> c. Else, return a value in the <code>__dict__</code> of instance I<br> c. Else, call a non data descriptor or return a value found in step a</p>
</li>
<li><p>From a class C, search the class, its superclasses, and its metaclasses tree, as follows:<br>a. Search the <code>__dict__</code> of all metaclass on the <code>__mro__</code> found at C’s <code>__class__</code><br>b. If a data descriptor was found in step <em>a</em>, call it and exit<br>   c. Else, call a descriptor or return a value in the <code>__dict__</code> of a class on C’s own <code>__mro__</code><br>d. Else, call a non-data descriptor or return a value found in step a</p>
</li>
<li><p>In both rule 1 and 2, built-in operations use just step a sources</p>
</li>
</ol>
<p>This applies to normal, explict attribute fetch only. The implicit lookup of metod names for built-ins doesn’t follow these rules.</p>
<p><strong>Assignment inheritance</strong></p>
<p>When an attribute assignment is run for new-style classes, a data descriptor with <code>__set__</code> method is acquired from a class by inheritance using the MRO, and has precendence over the normal storage model. </p>
<p><strong>The built-ins special case</strong></p>
<p>TODO</p>
<h1 id="Summary"><a href="#Summary" class="headerlink" title="Summary"></a>Summary</h1><p>In this chapter, we studied metaclasses and explored examples of them in action. Metaclass allow us to tap into the class creation protocol of Python, in order to manage or augment user-defined classes. They may provide better solutions for API writers than manual code or helper functions.</p>
<ol>
<li><p><strong>What is a metaclass?</strong><br>A metaclass is a class used to create a class. Normal new-style classes are instances of the <strong>type</strong> class by default. Metaclass are usually subclass of the <strong>type</strong> class, which redifines class creation protocol methods in order to customize the class creation call issued at the end of a class statement; they typicall refined the methods <code>__new__</code> and <code>__init__</code> to tap into the class creation protocol. </p>
</li>
<li><p><strong>How do you declare the metaclass of a class?</strong><br>Python 2.x <code>__metaclass__ = M</code> Python 3.x <code>class C(metaclass=M)</code></p>
</li>
<li><p><strong>How do class decorators overlap with metaclasses for managing classes?</strong><br>Because both are automaticall triggered at the end of class statement, class decorators and metaclasses can both used to manage classes. Decorators rebind a class name to callable’s result and metaclass route class creation through a callaable, but hooks can be used for similar purpose. To manage classes, decorators simply augment and return the orign class object. Metaclass argument a class after they create it. Decorators may have a slight disadvantage in this role if a new class must be defined, because the original class has already been created.</p>
</li>
<li><p><strong>How doclass decorators overlap with metalcasses for managing instances?</strong><br>Becuase both automatically triggered at the end the class statement, we can use both class decorators and metaclass to manage class instance, by inserting a wrapper object to cath instance creation calls. Decorators my rebind the class name to callable run on instance creation that retains the original class object. Metaclass can do the same, but may hava a slight disadvantage in this role, because they must also create the class object.</p>
</li>
</ol>
<h1 id="References"><a href="#References" class="headerlink" title="References"></a>References</h1><ul>
<li><em>Learning Python</em></li>
</ul>
</div><script type="text/javascript" src="/js/share.js?v=0.0.0" async></script><a data-url="http://blog.hotbaby.org/2017/07/16/Python-metaclass/" data-id="cj57ey8kt0026btfsj4c9vux2" class="article-share-link">分享到</a><div class="tags"><a href="/tags/Python/">Python</a></div><div class="post-nav"><a href="/2017/07/10/Python-descriptor/" class="next">Python  descriptor</a></div><div id="disqus_thread"><script>var disqus_shortname = 'hotbaby-1';
var disqus_identifier = '2017/07/16/Python-metaclass/';
var disqus_title = 'Python metaclass';
var disqus_url = 'http://blog.hotbaby.org/2017/07/16/Python-metaclass/';
(function() {
  var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
  dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();</script><script id="dsq-count-scr" src="//hotbaby-1.disqus.com/count.js" async></script></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form action="//www.baidu.com/baidu" method="get" accept-charset="utf-8" target="_blank" class="search-form"><input type="search" name="word" maxlength="20" placeholder="Search"/><input type="hidden" name="si" value="http://blog.hotbaby.org"/><input name="tn" type="hidden" value="bds"/><input name="cl" type="hidden" value="3"/><input name="ct" type="hidden" value="2097152"/><input name="s" type="hidden" value="on"/></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/django/">django</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/git/">git</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/旅行/">旅行</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/tags/Cobra/" style="font-size: 15px;">Cobra</a> <a href="/tags/django/" style="font-size: 15px;">django</a> <a href="/tags/Python/" style="font-size: 15px;">Python</a> <a href="/tags/Lisp/" style="font-size: 15px;">Lisp</a> <a href="/tags/Paul-Graham/" style="font-size: 15px;">Paul Graham</a> <a href="/tags/电影/" style="font-size: 15px;">电影</a> <a href="/tags/跑步/" style="font-size: 15px;">跑步</a> <a href="/tags/PEP/" style="font-size: 15px;">PEP</a> <a href="/tags/PyPI/" style="font-size: 15px;">PyPI</a> <a href="/tags/decorator/" style="font-size: 15px;">decorator</a> <a href="/tags/closure/" style="font-size: 15px;">closure</a> <a href="/tags/Flask/" style="font-size: 15px;">Flask</a> <a href="/tags/RSS/" style="font-size: 15px;">RSS</a> <a href="/tags/selenium/" style="font-size: 15px;">selenium</a> <a href="/tags/cache/" style="font-size: 15px;">cache</a> <a href="/tags/git/" style="font-size: 15px;">git</a> <a href="/tags/hexo/" style="font-size: 15px;">hexo</a> <a href="/tags/json/" style="font-size: 15px;">json</a> <a href="/tags/nginx/" style="font-size: 15px;">nginx</a> <a href="/tags/shadowsocks/" style="font-size: 15px;">shadowsocks</a> <a href="/tags/互联网/" style="font-size: 15px;">互联网</a> <a href="/tags/八达岭长城/" style="font-size: 15px;">八达岭长城</a> <a href="/tags/腾讯/" style="font-size: 15px;">腾讯</a> <a href="/tags/读书/" style="font-size: 15px;">读书</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最新文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2017/07/16/Python-metaclass/">Python metaclass</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/07/10/Python-descriptor/">Python  descriptor</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/07/09/Selenium/">Selenium</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/07/09/Python-context/">Python context</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/06/09/Python-debug/">Python debug</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/06/09/debian-timezone/">debian timezone</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/06/09/Python-customization/">Python customization</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/06/08/Python-pip-mirror/">Python pip mirror</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/06/01/Lisp/">Lisp</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/05/17/django-db-router/">Django database router</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 友情链接</i></div><ul></ul><a href="http://paulgraham.com/" title="Paul Graham" target="_blank">Paul Graham</a><ul></ul><a href="http://babywolfh.win" title="babywolfh's blog" target="_blank">babywolfh's blog</a><ul></ul><a href="https://www.haomwei.com/" title="9441's blog" target="_blank">9441's blog</a><ul></ul><a href="https://www.biaodianfu.com/" title="baiodianfu" target="_blank">baiodianfu</a><ul></ul><a href="https://docs.python.org/2/" title="Python 2.7.12 Documentation" target="_blank">Python 2.7.12 Documentation</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">© 2017 <a href="/." rel="nofollow">hotbaby</a></div></div></div><a id="rocket" href="#top" class="show"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.pack.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="/css/jquery.fancybox.css?v=0.0.0"><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "//hm.baidu.com/hm.js?bf8f991bdc9a9dc0e9009de94acefaf6";
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(hm, s);
  })();
</script><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>