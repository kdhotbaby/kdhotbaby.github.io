<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="hotbaby's blog"><title>Python Metaclass | hotbaby</title><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/5.0.0/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.2/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.2/grids-responsive-min.css"><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/3.1.1/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><link rel="alternate" type="application/atom+xml" href="/atom.xml"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">Python Metaclass</h1><a id="logo" href="/.">hotbaby</a><p class="description">hotbaby's blog</p></div><div id="nav-menu"><a href="/." class="current"><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/history/"><i class="fa fa-history"> 历史</i></a><a href="/guestbook/"><i class="fa fa-comments"> 留言</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a></div></div><div id="layout" class="pure-g"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">Python Metaclass</h1><div class="post-meta">Jul 18, 2017<span> | </span><span class="category"><a href="/categories/Python/">Python</a></span><script src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js" async></script><span id="busuanzi_container_page_pv"> | <span id="busuanzi_value_page_pv"></span><span> Hits</span></span></div><a data-disqus-identifier="2017/07/18/untitled-1500307428319/" href="/2017/07/18/untitled-1500307428319/#disqus_thread" class="disqus-comment-count"></a><div class="post-content"><p><em>[Metaclasses] are deeper magic than 99% of users should ever worry about. If you wonder whether you need them, you don’t (the people who actually need them know with certainty that they need them, and don’t need an explanation about why).</em> The Python core developer Time Peters said.</p>
<p>元类是创建类的类。新风格(new-style)类是type类的实例。元类是type类的派生类，通过重载type类的<code>__new__</code>和<code>__init__</code>方法，重新定义类创建协议，来实现类创建的定制化。</p>
<h2 id="元类模型"><a href="#元类模型" class="headerlink" title="元类模型"></a>元类模型</h2><p>(对象)实例是通过类创建，类是通过type类创建，元类是type类的派生类。</p>
<ul>
<li>类型(自定义)是通过type类或type派生元类创建</li>
<li>元类是type类的派生类</li>
<li>用户自定义类是type类的实例</li>
<li>用户自定义类可以生成自己的实例</li>
</ul>
<h3 id="类声明协议"><a href="#类声明协议" class="headerlink" title="类声明协议"></a>类声明协议</h3><p>Python解释器在类声明语句结束时，调用type类型创建，<code>class = type(classname, superclasses, attributedict)</code>。</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">type.__new__(meta, classname, superclasses, attributedict)</div><div class="line">type.__init__(cls, classname, superclasses, attributedict)</div></pre></td></tr></table></figure>
<h2 id="声明元类"><a href="#声明元类" class="headerlink" title="声明元类"></a>声明元类</h2><p>Py3与Py2声明元类的方式不一样：</p>
<p>Py3声明元类</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&gt;&gt;&gt; </span><span class="class"><span class="keyword">class</span> <span class="title">Metaclass</span><span class="params">(type)</span>:</span></div><div class="line"><span class="meta">... </span>    <span class="function"><span class="keyword">def</span> <span class="title">__new__</span><span class="params">(meta, classname, superclasses, attributedict)</span>:</span></div><div class="line"><span class="meta">... </span>        <span class="keyword">return</span> type(classname, superclasses, attributedict)</div><div class="line"><span class="meta">... </span>    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(cls, classname, superclasses, attributedict)</span>:</span></div><div class="line"><span class="meta">... </span>        <span class="keyword">pass</span></div><div class="line"><span class="meta">... </span></div><div class="line"><span class="meta">&gt;&gt;&gt; </span><span class="class"><span class="keyword">class</span> <span class="title">Dummy</span><span class="params">(object, metaclass=Metaclass)</span>:</span></div><div class="line"><span class="meta">... </span>    <span class="keyword">pass</span></div><div class="line">...</div></pre></td></tr></table></figure>
<p>Py2声明元类</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&gt;&gt;&gt; </span><span class="class"><span class="keyword">class</span> <span class="title">Metaclass</span><span class="params">(type)</span>:</span></div><div class="line"><span class="meta">... </span>    <span class="function"><span class="keyword">def</span> <span class="title">__new__</span><span class="params">(meta, classname, superclasses, attributedict)</span>:</span></div><div class="line"><span class="meta">... </span>        <span class="keyword">return</span> type(classname, superclasses, attributedict)</div><div class="line"><span class="meta">... </span>    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(cls, classname, superclasses, attributedict)</span>:</span></div><div class="line"><span class="meta">... </span>        <span class="keyword">pass</span></div><div class="line"><span class="meta">... </span></div><div class="line"><span class="meta">&gt;&gt;&gt; </span><span class="class"><span class="keyword">class</span> <span class="title">Dummy</span><span class="params">(object)</span>:</span></div><div class="line"><span class="meta">... </span>    __metaclass__ = Metaclass</div><div class="line">...</div></pre></td></tr></table></figure>
<h2 id="继承和实例"><a href="#继承和实例" class="headerlink" title="继承和实例"></a>继承和实例</h2><ul>
<li>元类继承于type类</li>
<li>元类的声明可以被派生类继承</li>
<li>元类的属性不能被类的实例继承</li>
<li>元类的属性可以被类获取</li>
</ul>
<p><strong>元类继承于type类</strong></p>
<p>元类重载type类的<code>__new__</code>和<code>__init__</code>方法，定制类的创建和初始化。</p>
<p><strong>元类的声明可以被派生类继承</strong></p>
<p><strong>元类的属性不能被类实例继承</strong></p>
<p>类是元类的实例，元类的行为可以被类访问，当类不能被类的实例访问。</p>
<p><strong>元类的属性可以被类获取</strong></p>
<h3 id="继承"><a href="#继承" class="headerlink" title="继承"></a>继承</h3><p><strong>Python继承算法</strong></p>
<ol>
<li>对于一个实例，先搜索这个实例，再搜索实例的类，再搜索超类<br> a. 先搜索实例的<code>__dict__</code><br> b. 再搜索该实例的类的<code>__mro__</code>对应类的<code>__dict__</code></li>
<li>对于一个类，先搜索类，再搜索超类，再搜索元类<br> a. 根据<code>__mro__</code>搜索类的<code>__dict__</code><br> b. 再搜索元类的<code>__dict__</code></li>
<li>规则1和2中，再b阶段中，数据描述的优先级高</li>
<li>规则1和2中，对于内置的运算符，跳过a阶段</li>
</ol>
<p><strong>数据描述符继承算法</strong></p>
<p>对于定义了<code>__set__</code>拦截赋值的描述符就是数据描述符。</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&gt;&gt;&gt; </span><span class="class"><span class="keyword">class</span> <span class="title">D</span><span class="params">(object)</span>:</span></div><div class="line"><span class="meta">... </span>    <span class="function"><span class="keyword">def</span> <span class="title">__get__</span><span class="params">(self, ins, _type)</span>:</span></div><div class="line"><span class="meta">... </span>            print(<span class="string">'call D.__get__'</span>)</div><div class="line"><span class="meta">... </span>    <span class="function"><span class="keyword">def</span> <span class="title">__set__</span><span class="params">(self, ins, value)</span>:</span></div><div class="line"><span class="meta">... </span>            print(<span class="string">'call D.__set__'</span>)</div><div class="line"><span class="meta">... </span></div><div class="line"><span class="meta">&gt;&gt;&gt; </span></div><div class="line"><span class="meta">&gt;&gt;&gt; </span><span class="class"><span class="keyword">class</span> <span class="title">Dummy</span><span class="params">(object)</span>:</span></div><div class="line"><span class="meta">... </span>    d = D()</div><div class="line"><span class="meta">... </span></div><div class="line"><span class="meta">&gt;&gt;&gt; </span>ins = Dummy()</div><div class="line"><span class="meta">&gt;&gt;&gt; </span>ins.d</div><div class="line">call D.__get__</div><div class="line"><span class="meta">&gt;&gt;&gt; </span>ins.d = <span class="string">'spam'</span></div><div class="line">call D.__set__</div></pre></td></tr></table></figure>
<p>未定义<code>__set__</code>的描述符</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&gt;&gt;&gt; </span><span class="class"><span class="keyword">class</span> <span class="title">D</span><span class="params">(object)</span>:</span></div><div class="line"><span class="meta">... </span>    <span class="function"><span class="keyword">def</span> <span class="title">__get__</span><span class="params">(self, ins, value)</span>:</span></div><div class="line"><span class="meta">... </span>            print(<span class="string">'call D.__get__'</span>)</div><div class="line"><span class="meta">... </span></div><div class="line"><span class="meta">&gt;&gt;&gt; </span><span class="class"><span class="keyword">class</span> <span class="title">Dummy</span><span class="params">(object)</span>:</span></div><div class="line"><span class="meta">... </span>    d = D()</div><div class="line"><span class="meta">... </span></div><div class="line"><span class="meta">&gt;&gt;&gt; </span>ins = Dummy()</div><div class="line"><span class="meta">&gt;&gt;&gt; </span>ins.d</div><div class="line">call D.__get__</div><div class="line"><span class="meta">&gt;&gt;&gt; </span>ins.d = <span class="string">'spam'</span></div><div class="line"><span class="meta">&gt;&gt;&gt; </span>ins.d</div><div class="line"><span class="string">'spam</span></div></pre></td></tr></table></figure>
<p>Python 的继承算法</p>
<ol>
<li>对于实例I，先搜索实例，再搜索类，再搜索超类<br> a. 根据类的<code>__mro__</code>搜索超类的<code>__dict__</code><br> b. If 如果在a阶段发现了数据描述，调用该数据描述，完成后退出<br> c. Else 返回该实例<code>__dict__</code>中的值<br> d. Else 调用非数据描述符，并放回结果</li>
<li>对于类C，搜索类，再搜索超类，再搜索元类<br> a. 搜索类的<code>__mro__</code>依次搜索类的<code>__dict__</code><br> b. If 如果在a阶段发现了数据描述符，调用该数据描述符，完成后退出<br> c. Else 返回该类<code>__dict__</code>中值<br> d. Else 调用非数据描述符，返回结果</li>
</ol>
<blockquote>
<p>Note, 数据描述符的优先级 &gt; 普通属性 &gt; 非数据描述符</p>
</blockquote>
<h2 id="元类与类装饰器"><a href="#元类与类装饰器" class="headerlink" title="元类与类装饰器"></a>元类与类装饰器</h2><p>TODO</p>
<h2 id="示例"><a href="#示例" class="headerlink" title="示例"></a>示例</h2><p>django ORM</p>
<p>ripozo API</p>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ul>
<li><em>Learning Python 5th Edition</em></li>
</ul>
</div><script type="text/javascript" src="/js/share.js?v=0.0.0" async></script><a data-url="http://blog.hotbaby.org/2017/07/18/untitled-1500307428319/" data-id="cjf0cpnbk007c0jfsxhwyndr0" class="article-share-link">分享到</a><div class="tags"><a href="/tags/Python/">Python</a></div><div class="post-nav"><a href="/2017/07/19/untitled-1499683380864/" class="pre">OAuth</a><a href="/2017/07/10/Python-descriptor/" class="next">Python  Descriptor</a></div><div id="disqus_thread"><script>var disqus_shortname = 'hotbaby-1';
var disqus_identifier = '2017/07/18/untitled-1500307428319/';
var disqus_title = 'Python Metaclass';
var disqus_url = 'http://blog.hotbaby.org/2017/07/18/untitled-1500307428319/';
(function() {
  var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
  dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();</script><script id="dsq-count-scr" src="//hotbaby-1.disqus.com/count.js" async></script></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form action="//www.baidu.com/baidu" method="get" accept-charset="utf-8" target="_blank" class="search-form"><input type="search" name="word" maxlength="20" placeholder="Search"/><input type="hidden" name="si" value="http://blog.hotbaby.org"/><input name="tn" type="hidden" value="bds"/><input name="cl" type="hidden" value="3"/><input name="ct" type="hidden" value="2097152"/><input name="s" type="hidden" value="on"/></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Python/">Python</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/django/">django</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/git/">git</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/旅行/">旅行</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/tags/Django/" style="font-size: 15px;">Django</a> <a href="/tags/nginx/" style="font-size: 15px;">nginx</a> <a href="/tags/django/" style="font-size: 15px;">django</a> <a href="/tags/MySQL/" style="font-size: 15px;">MySQL</a> <a href="/tags/Python/" style="font-size: 15px;">Python</a> <a href="/tags/Lisp/" style="font-size: 15px;">Lisp</a> <a href="/tags/Paul-Graham/" style="font-size: 15px;">Paul Graham</a> <a href="/tags/电影/" style="font-size: 15px;">电影</a> <a href="/tags/跑步/" style="font-size: 15px;">跑步</a> <a href="/tags/PEP/" style="font-size: 15px;">PEP</a> <a href="/tags/PyPI/" style="font-size: 15px;">PyPI</a> <a href="/tags/decorator/" style="font-size: 15px;">decorator</a> <a href="/tags/closure/" style="font-size: 15px;">closure</a> <a href="/tags/Cobra/" style="font-size: 15px;">Cobra</a> <a href="/tags/Flask/" style="font-size: 15px;">Flask</a> <a href="/tags/RSS/" style="font-size: 15px;">RSS</a> <a href="/tags/selenium/" style="font-size: 15px;">selenium</a> <a href="/tags/cache/" style="font-size: 15px;">cache</a> <a href="/tags/git/" style="font-size: 15px;">git</a> <a href="/tags/hexo/" style="font-size: 15px;">hexo</a> <a href="/tags/HTTP/" style="font-size: 15px;">HTTP</a> <a href="/tags/json/" style="font-size: 15px;">json</a> <a href="/tags/shadowsocks/" style="font-size: 15px;">shadowsocks</a> <a href="/tags/OAuth/" style="font-size: 15px;">OAuth</a> <a href="/tags/nodejs/" style="font-size: 15px;">nodejs</a> <a href="/tags/12factor/" style="font-size: 15px;">12factor</a> <a href="/tags/互联网/" style="font-size: 15px;">互联网</a> <a href="/tags/八达岭长城/" style="font-size: 15px;">八达岭长城</a> <a href="/tags/腾讯/" style="font-size: 15px;">腾讯</a> <a href="/tags/读书/" style="font-size: 15px;">读书</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最新文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2017/12/06/untitled-1511875326986/">Django异常处理</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/12/04/untitled-1512378645196/">Python命令行环境变量</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/12/04/untitled-1512358382696/">MacOS安装PIL</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/12/01/untitled-1501583914843/">MySQL</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/11/08/untitled-1510111268169/">mysql_config_editor</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/11/06/untitled-1509677215394/">UnicodeDecodeError</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/10/28/untitled-1505555926262/">node js</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/10/24/untitled-1508807216535-1/">旅行 写作 编程</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/10/23/Django-db/">Django条件查询</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/10/23/untitled-1508722254450/">Django Model Field Choices</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 友情链接</i></div><ul></ul><a href="http://paulgraham.com/" title="Paul Graham" target="_blank">Paul Graham</a><ul></ul><a href="http://babywolfh.win" title="babywolfh's blog" target="_blank">babywolfh's blog</a><ul></ul><a href="https://www.haomwei.com/" title="9441's blog" target="_blank">9441's blog</a><ul></ul><a href="https://www.biaodianfu.com/" title="标点符" target="_blank">标点符</a><ul></ul><a href="https://docs.python.org/2/" title="Python 2.7.12 Documentation" target="_blank">Python 2.7.12 Documentation</a><ul></ul><a href="http://aosabook.org/en/index.html" title="The Architecture of Open Source Applications" target="_blank">The Architecture of Open Source Applications</a><ul></ul><a href="http://www.pycon.org/" title="Python Community" target="_blank">Python Community</a><ul></ul><a href="http://blog.dujiong.net" title="一期一会" target="_blank">一期一会</a><ul></ul><a href="https://www.kaggle.com/" title="kaggle" target="_blank">kaggle</a><ul></ul><a href="https://chenrudan.github.io" title="chenrudan" target="_blank">chenrudan</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">© 2017 <a href="/." rel="nofollow">hotbaby</a></div></div></div><a id="rocket" href="#top" class="show"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.pack.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="/css/jquery.fancybox.css?v=0.0.0"><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "//hm.baidu.com/hm.js?bf8f991bdc9a9dc0e9009de94acefaf6";
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(hm, s);
  })();
</script><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>